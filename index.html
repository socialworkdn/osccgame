<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OSCC Live Classroom</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; overflow-x: hidden; }
        .animate-bounce-short { animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        /* Timer Bar Animation */
        .timer-progress { transition: width 1s linear; }
        
        /* Highlight Animation */
        .correct-answer-highlight {
            background-color: #10b981 !important; /* Green-500 */
            border-color: #059669 !important; /* Green-600 */
            color: white !important;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
        }
    </style>

    <!-- React & Firebase -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        
        // Config ของคุณ
        const YOUR_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAdXrEJVOU8zHtnCjd0tnCT0Gg9ZIioYeE",
          authDomain: "oscc-quiz.firebaseapp.com",
          projectId: "oscc-quiz",
          storageBucket: "oscc-quiz.firebasestorage.app",
          messagingSenderId: "246513256530",
          appId: "1:246513256530:web:ba60ab8ec6c8f2a1d4f78b",
          measurementId: "G-EV1HQLEGRE"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(YOUR_FIREBASE_CONFIG);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'oscc-quiz-room-v1'; 

        // Database References
        const getGameStateRef = () => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('state').doc('current');
        const getPlayersRef = () => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('players');

        // Questions Data (Total 19 Questions)
        const QUESTIONS = [
            // --- Part 1: OSCC & Domestic Violence (10) ---
            { q: "OSCC ย่อมาจากอะไร?", a: ["One Stop Service Center", "One Stop Crisis Center", "Online Social Care", "One Safe Child Center"], c: 1 },
            { q: "แจ้งเหตุ OSCC รพ.ดำเนินสะดวก โทรเบอร์?", a: ["1669", "191", "622", "1112"], c: 2 },
            { q: "เกณฑ์ผู้ป่วย 'เด็ก' ต้องอายุไม่เกินกี่ปี?", a: ["12 ปี", "15 ปี", "18 ปี", "20 ปี"], c: 2 },
            { q: "ข้อใด 'ไม่นับ' เป็นเคส OSCC?", a: ["สามีทำร้ายภรรยา", "วัยรุ่นตีกันเอง (วิวาททั่วไป)", "แม่เลี้ยงตีลูกเลี้ยง", "ครูทำร้ายนักเรียน"], c: 1 },
            { q: "ความรุนแรงทางเพศ ต้องส่ง OSCC หรือไม่?", a: ["ส่งเฉพาะผู้หญิง", "ส่งเฉพาะเด็ก", "ส่งทุกกรณี", "ไม่ต้องส่ง"], c: 2 },
            { q: "ด่านแรกใน รพ. เมื่อผู้ป่วยมาถึงคือ?", a: ["ห้องฉุกเฉิน (ER)", "ทันตกรรม", "ห้องผ่าตัด", "กลับบ้าน"], c: 0 },
            { q: "นักสังคมสงเคราะห์ รพ.ดำเนินฯ ชื่อพี่อะไร?", a: ["พี่ป้อม", "พี่ปอม", "พี่ปลา", "พี่เปิ้ล"], c: 1 },
            { q: "ผู้ชายถูกทำร้าย เป็น OSCC เมื่อ?", a: ["ถูกแฟน/คนในบ้านทำร้าย", "ถูกเพื่อนต่อย", "โดนรุมหน้างานวัด", "เป็นทุกกรณี"], c: 0 },
            { q: "หัวใจสำคัญของการทำงาน OSCC คือ?", a: ["ออกข่าว", "จับโจร", "รักษาความลับ/ความปลอดภัย", "เรียกเงิน"], c: 2 },
            { q: "สโลแกนสำคัญคือ?", a: ["ไม่ยุ่งเรื่องชาวบ้าน", "ไม่ยอมรับ ไม่นิ่งเฉย ไม่กระทำ", "รักวัวให้ผูก รักลูกให้ตี", "ตาต่อตา ฟันต่อฟัน"], c: 1 },
            
            // --- Part 2: Healthcare Rights (5) ---
            { q: "นโยบาย '30 บาทรักษาทุกที่' ใช้เอกสารอะไรเพียงใบเดียวในการเข้ารับบริการ?", a: ["สำเนาทะเบียนบ้าน", "ใบส่งตัวจากโรงพยาบาลต้นสังกัด", "บัตรประชาชนใบเดียว", "บัตรผู้มีรายได้น้อย"], c: 2 },
            { q: "สิทธิ UCEP (เจ็บป่วยฉุกเฉินวิกฤต) คุ้มครองการรักษาฟรีใน 72 ชม.แรก กรณีใด?", a: ["ปวดท้องโรคกระเพาะรุนแรง", "แขนหักแต่ยังรู้สึกตัวดี", "หมดสติ ไม่รู้สึกตัว หายใจไม่ออก", "ท้องเสียรุนแรง อ่อนเพลีย"], c: 2 },
            { q: "ผู้ถือ 'บัตรทอง' ย้ายสถานพยาบาลออนไลน์ได้ปีละกี่ครั้ง?", a: ["1 ครั้ง", "2 ครั้ง", "4 ครั้ง", "ย้ายได้ไม่จำกัดจำนวนครั้ง"], c: 2 },
            { q: "เจ็บป่วยเล็กน้อย (Common Illness) เช่น ปวดหัว เจ็บคอ ผู้ใช้สิทธิบัตรทองรับยาฟรีได้ที่ไหน?", a: ["ร้านสะดวกซื้อทั่วไป", "คลินิกเสริมความงาม", "ร้านยาคุณภาพที่เข้าร่วมโครงการ", "โรงพยาบาลเอกชนทุกแห่ง"], c: 2 },
            { q: "เจ็บป่วยฉุกเฉิน 'ไม่วิกฤต' หากเข้า รพ.เอกชนนอกสิทธิ ใครต้องรับผิดชอบค่าใช้จ่าย?", a: ["รัฐบาลจ่ายให้ทั้งหมด", "ใช้สิทธิ UCEP ได้", "ผู้ป่วยต้องจ่ายเงินเอง", "โรงพยาบาลต้นสังกัดตามมาจ่ายให้"], c: 2 },

            // --- Part 3: Social Security & Civil Servant Rights (New 4) ---
            { 
                q: "ฟรีแลนซ์ หรือผู้ประกอบอาชีพอิสระ ที่ต้องการมีสิทธิประกันสังคม ต้องสมัครมาตราใด?", 
                a: ["มาตรา 33", "มาตรา 39", "มาตรา 40", "มาตรา 44"], 
                c: 2 
            },
            { 
                q: "หากเป็น 'ข้าราชการ' ต้องการใช้ 'ยาต้นแบบ' (Original) ที่มีราคาสูงกว่าเกณฑ์ ต้องทำอย่างไร?", 
                a: ["เบิกได้เต็มจำนวนเหมือนเดิม", "ต้องร่วมจ่าย (Co-payment) ส่วนต่างเอง", "ไม่สามารถเบิกได้เลย", "ต้องให้แพทย์ทำเรื่องขออนุมัติพิเศษทุกครั้ง"], 
                c: 1 
            },
            { 
                q: "ผู้ประกันตน 'ประกันสังคม' สามารถเบิกค่าทันตกรรม (ทำฟัน) ได้ปีละเท่าไหร่?", 
                a: ["600 บาท", "900 บาท", "1,200 บาท", "เบิกได้ตามจริงไม่จำกัดวงเงิน"], 
                c: 1 
            },
            { 
                q: "'อายุครบ 20 ปีบริบูรณ์' มีผลอย่างไรกับสิทธิรักษาพยาบาลของลูกข้าราชการ?", 
                a: ["ใช้สิทธิเบิกตรงได้ต่อไปจนจบปริญญาตรี", "หมดสิทธิเบิกตรงทันที ต้องเปลี่ยนไปใช้สิทธิบัตรทอง/ประกันสังคม", "ต้องจ่ายเงินสมทบเพิ่มเพื่อรักษาสิทธิเดิม", "ใช้สิทธิได้เฉพาะกรณีอุบัติเหตุฉุกเฉินเท่านั้น"], 
                c: 1 
            }
        ];

        // ==========================================
        // 2. TEACHER COMPONENT (Controller + Auto Timer)
        // ==========================================
        const TeacherMode = ({ user, authError }) => {
            const [gameState, setGameState] = React.useState(null);
            const [players, setPlayers] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [timeLeft, setTimeLeft] = React.useState(15); 

            // Listen to Game State & Players
            React.useEffect(() => {
                const unsubState = getGameStateRef().onSnapshot(doc => {
                    setGameState(doc.exists ? doc.data() : { status: 'lobby', qIdx: 0, showAnswer: false });
                    setLoading(false);
                }, err => {
                    console.error("State Error:", err);
                    if(err.code === 'permission-denied') alert("ติดสิทธิ์ Permission Denied: กรุณาแก้ Firestore Rules");
                });

                const unsubPlayers = getPlayersRef().orderBy('score', 'desc').onSnapshot(snapshot => {
                    setPlayers(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubState(); unsubPlayers(); };
            }, []);

            // Control Actions
            const updateState = async (newData) => {
                await getGameStateRef().set({ ...gameState, ...newData }, { merge: true });
            };

            const resetGame = async () => {
                if(!confirm("⚠️ ยืนยันการล้างข้อมูล?\n\n- ข้อมูลคะแนนทั้งหมดจะหายไป\n- ผู้เล่นต้องเข้าใหม่\n- เกมจะเริ่มที่หน้า Lobby")) return;
                
                try {
                    const pSnap = await getPlayersRef().get();
                    if (!pSnap.empty) {
                        const batch = db.batch();
                        pSnap.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    }
                    await getGameStateRef().set({ 
                        status: 'lobby', 
                        qIdx: 0, 
                        showAnswer: false, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    alert("✅ รีเซ็ตระบบเรียบร้อยแล้ว");
                } catch (err) {
                    console.error("Reset Error:", err);
                    alert("❌ ไม่สามารถรีเซ็ตได้: " + err.message);
                }
            };

            const startGame = () => updateState({ status: 'playing', qIdx: 0, showAnswer: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            const revealAnswer = () => updateState({ showAnswer: true });
            const nextQuestion = () => {
                if (gameState.qIdx < QUESTIONS.length - 1) {
                    updateState({ qIdx: gameState.qIdx + 1, showAnswer: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                } else {
                    updateState({ status: 'finished' });
                }
            };

            // Auto Timer Logic
            React.useEffect(() => {
                if (gameState?.status === 'playing') {
                    if (gameState.showAnswer) {
                        setTimeLeft(5); // Force 5 seconds for answer
                    } else {
                        setTimeLeft(15); // 15 seconds for question
                    }
                }
            }, [gameState?.qIdx, gameState?.showAnswer, gameState?.status]);

            React.useEffect(() => {
                if (gameState?.status !== 'playing') return;

                if (timeLeft > 0) {
                    const timerId = setTimeout(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearTimeout(timerId);
                } else {
                    // Time up actions
                    if (!gameState.showAnswer) {
                        revealAnswer(); // 15s ends -> Show Answer
                    } else {
                        nextQuestion(); // 5s ends -> Next Question
                    }
                }
            }, [timeLeft, gameState]);


            if (loading) return <div className="text-center p-10 text-white">Connecting to Firestore...</div>;

            // --- TEACHER: LOBBY ---
            if (!gameState || gameState.status === 'lobby') {
                return (
                    <div className="min-h-screen bg-slate-800 text-white p-6 flex flex-col items-center">
                        <div className="w-full max-w-4xl">
                            <div className="flex justify-between items-center mb-10 border-b border-slate-600 pb-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-rose-400">OSCC & สิทธิการรักษา</h1>
                                    <p className="text-slate-400">Classroom Controller</p>
                                </div>
                                <button onClick={resetGame} className="text-xs text-red-400 border border-red-400 px-3 py-1 rounded hover:bg-red-400/10">Reset Room</button>
                            </div>

                            <div className="bg-slate-700/50 rounded-2xl p-8 text-center mb-8 border-2 border-dashed border-slate-500">
                                <h2 className="text-6xl font-bold text-white mb-4">{players.length}</h2>
                                <p className="text-xl text-slate-300">นักเรียนที่เข้าร่วม</p>
                                <div className="flex flex-wrap gap-2 justify-center mt-6">
                                    {players.map(p => (
                                        <span key={p.id} className="bg-slate-600 px-3 py-1 rounded-full text-sm animate-bounce-short">{p.name}</span>
                                    ))}
                                </div>
                            </div>
                            
                            {authError && (
                                <div className="bg-red-500/10 border border-red-500 text-red-200 p-4 rounded-xl mb-6 text-left text-sm">
                                    <p className="font-bold">⚠️ Connection Error</p>
                                    <p className="opacity-80 mt-1">{authError}</p>
                                </div>
                            )}

                            <button onClick={startGame} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white text-2xl font-bold py-6 rounded-xl shadow-lg transform transition hover:scale-105">
                                เริ่มเกม (START GAME)
                            </button>
                        </div>
                    </div>
                );
            }

            // --- TEACHER: PLAYING ---
            if (gameState.status === 'playing') {
                const q = QUESTIONS[gameState.qIdx];
                return (
                    <div className="min-h-screen bg-slate-100 p-6 flex flex-col items-center justify-center relative">
                        {/* Status Bar */}
                        <div className={`absolute top-0 left-0 h-2 bg-rose-500 transition-all duration-1000 ease-linear`} style={{ width: `${(timeLeft / (gameState.showAnswer ? 5 : 15)) * 100}%` }}></div>

                        <div className="w-full max-w-5xl bg-white rounded-3xl shadow-xl overflow-hidden">
                            {/* Header */}
                            <div className="bg-slate-800 p-6 flex justify-between items-center text-white">
                                <h2 className="text-2xl font-bold">ข้อที่ {gameState.qIdx + 1}/{QUESTIONS.length}</h2>
                                <div className="flex items-center gap-4">
                                    <div className={`text-3xl font-mono font-bold px-4 py-1 rounded-lg ${gameState.showAnswer ? 'bg-yellow-500 text-black' : 'bg-slate-900 text-rose-400'}`}>
                                        <i className="fa-regular fa-clock mr-2"></i>{timeLeft}s
                                    </div>
                                    <div className="text-xl opacity-70">| ผู้เล่น: {players.length}</div>
                                </div>
                            </div>
                            
                            {/* Question */}
                            <div className="p-10 text-center">
                                <h1 className="text-3xl md:text-4xl font-bold text-slate-800 mb-10 leading-relaxed">{q.q}</h1>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {q.a.map((opt, i) => {
                                        let bg = "bg-slate-100 text-slate-600";
                                        // Logic สีสำหรับครู
                                        if (gameState.showAnswer) {
                                            if (i === q.c) bg = "correct-answer-highlight"; // เฉลยสีเขียว
                                            else bg = "bg-slate-200 opacity-40 grayscale";
                                        }
                                        return (
                                            <div key={i} className={`p-6 md:p-8 rounded-xl text-xl md:text-2xl font-semibold transition-all duration-300 border-2 border-transparent ${bg}`}>
                                                {opt}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="bg-slate-100 p-6 flex justify-between items-center border-t">
                                <div className="text-slate-500 text-sm italic">
                                    {gameState.showAnswer 
                                        ? "เฉลย 5 วินาที... กำลังไปข้อถัดไปอัตโนมัติ" 
                                        : "กำลังจับเวลาตอบ 15 วินาที..."}
                                </div>
                                <div className="flex gap-4">
                                    {!gameState.showAnswer ? (
                                        <button onClick={revealAnswer} className="text-slate-500 border border-slate-300 px-4 py-2 rounded-lg hover:bg-slate-200 text-sm">
                                            ข้ามเวลา (เฉลยเลย)
                                        </button>
                                    ) : (
                                        <button onClick={nextQuestion} className="text-slate-500 border border-slate-300 px-4 py-2 rounded-lg hover:bg-slate-200 text-sm">
                                            ข้ามเวลา (ไปข้อต่อไป)
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- TEACHER: LEADERBOARD (Top 10) ---
            if (gameState.status === 'finished') {
                return (
                    <div className="min-h-screen bg-slate-900 text-white p-6 flex flex-col items-center justify-center">
                        <i className="fa-solid fa-trophy text-yellow-400 text-6xl mb-6 animate-bounce"></i>
                        <h1 className="text-5xl font-bold mb-10 text-center bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500">
                            TOP 10 WINNERS
                        </h1>
                        
                        <div className="w-full max-w-3xl space-y-3 overflow-y-auto max-h-[70vh] px-4">
                            {players.slice(0, 10).map((p, i) => (
                                <div key={p.id} className={`flex items-center p-4 rounded-xl transform transition hover:scale-105 ${
                                    i===0 ? 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-yellow-500/50 shadow-lg border-2 border-yellow-300' :
                                    i===1 ? 'bg-slate-700 border border-slate-500' :
                                    i===2 ? 'bg-slate-700 border border-slate-500' : 
                                    'bg-slate-800'
                                }`}>
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl font-black mr-4 ${
                                        i===0 ? 'bg-white text-orange-500' : 
                                        i < 3 ? 'bg-slate-600 text-white' : 'bg-slate-900 text-slate-400'
                                    }`}>
                                        {i+1}
                                    </div>
                                    <div className="flex-1">
                                        <div className="text-xl font-bold">{p.name}</div>
                                    </div>
                                    <div className="text-2xl font-mono font-bold">
                                        {p.score.toLocaleString()}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <button onClick={resetGame} className="mt-8 text-slate-500 hover:text-white underline">
                            เริ่มเกมใหม่ (Reset)
                        </button>
                    </div>
                );
            }

            return <div>Loading...</div>;
        };

        // ==========================================
        // 3. STUDENT COMPONENT (Player)
        // ==========================================
        const StudentMode = ({ user, goHome, authError }) => {
            const [gameState, setGameState] = React.useState(null);
            const [name, setName] = React.useState('');
            const [joined, setJoined] = React.useState(false);
            const [selected, setSelected] = React.useState(null); 
            const [currentScore, setCurrentScore] = React.useState(0);
            const [clientTimer, setClientTimer] = React.useState(15); 
            
            React.useEffect(() => {
                const unsub = getGameStateRef().onSnapshot(doc => {
                    const data = doc.data();
                    if (!data) return;
                    
                    setGameState(prev => {
                        if (prev && prev.qIdx !== data.qIdx) {
                            setSelected(null);
                            setClientTimer(15); 
                        }
                        return data;
                    });
                });
                return () => unsub();
            }, []);

            React.useEffect(() => {
                if (gameState?.status === 'playing' && !gameState.showAnswer && clientTimer > 0) {
                    const timer = setTimeout(() => setClientTimer(prev => prev - 1), 1000);
                    return () => clearTimeout(timer);
                }
            }, [clientTimer, gameState]);

            const joinGame = async () => {
                if (!name.trim()) return;
                
                // Safety check: User must be authenticated
                if (!user) {
                    return; // Error is handled in UI
                }

                try {
                    await getPlayersRef().doc(user.uid).set({
                        name: name,
                        score: 0,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setJoined(true);
                } catch(e) {
                    console.error("Join Error:", e);
                    if (e.code === 'permission-denied') {
                        alert("⚠️ ไม่สามารถบันทึกชื่อได้ (Permission Denied)\n\nสาเหตุ: ไม่ได้ตั้งค่า Firestore Rules ใน Firebase Console\n\nวิธีแก้: ไปที่ Firebase Console > Firestore Database > Rules \nแล้วเปลี่ยนโค้ดเป็น: allow read, write: if true;");
                    } else {
                        alert(`❌ เกิดข้อผิดพลาด: ${e.message}\n(กรุณาตรวจสอบ Internet)`);
                    }
                }
            };

            const handleAnswer = async (idx) => {
                if (selected !== null) return; 
                setSelected(idx);

                const correctIdx = QUESTIONS[gameState.qIdx].c;
                const correct = (idx === correctIdx);
                
                if (correct) {
                    const newScore = currentScore + 100;
                    setCurrentScore(newScore);
                    await getPlayersRef().doc(user.uid).update({ score: newScore });
                }
            };

            if (!joined) {
                return (
                    <div className="min-h-screen bg-rose-50 p-6 flex flex-col items-center justify-center">
                        <div className="bg-white p-8 rounded-3xl shadow-lg w-full max-w-sm text-center">
                            <h2 className="text-2xl font-bold text-rose-500 mb-4">เข้าห้องเรียน</h2>
                            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="ใส่ชื่อของคุณ..." className="w-full bg-gray-100 p-4 rounded-xl mb-4 text-center text-lg outline-none focus:ring-2 focus:ring-rose-400" />
                            
                            {/* ERROR DISPLAY */}
                            {authError ? (
                                <button 
                                    onClick={() => alert("ข้อผิดพลาดจากระบบ (Auth Error):\n" + authError)}
                                    className="w-full bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-red-600 animate-pulse"
                                >
                                    ⚠️ เชื่อมต่อไม่ได้ (คลิกดูสาเหตุ)
                                </button>
                            ) : (
                                <button 
                                    onClick={joinGame} 
                                    disabled={!user}
                                    className={`w-full text-white font-bold py-4 rounded-xl shadow-lg transition-colors ${user ? 'bg-rose-500 hover:bg-rose-600' : 'bg-gray-400 cursor-not-allowed'}`}
                                >
                                    {user ? "ยืนยันชื่อ" : "กำลังเชื่อมต่อระบบ..."}
                                </button>
                            )}
                            
                            <p className="mt-4 text-xs text-gray-400">Status: {user ? "Online ✅" : (authError ? "Error ❌" : "Connecting...")}</p>
                        </div>
                    </div>
                );
            }

            if (!gameState || gameState.status === 'lobby') {
                return (
                    <div className="min-h-screen bg-rose-500 p-6 flex flex-col items-center justify-center text-white text-center">
                        <div className="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center mb-6 animate-pulse"><i className="fa-solid fa-user-clock text-4xl"></i></div>
                        <h2 className="text-3xl font-bold mb-2">สวัสดี {name}!</h2>
                        <p>รอคุณครูกดเริ่มเกมสักครู่...</p>
                    </div>
                );
            }

            if (gameState.status === 'playing') {
                const q = QUESTIONS[gameState.qIdx];
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col">
                        <div className="bg-white p-4 shadow-sm flex justify-between items-center z-10 sticky top-0 relative overflow-hidden">
                            <span className="bg-rose-100 text-rose-600 px-3 py-1 rounded-full font-bold text-sm">ข้อ {gameState.qIdx + 1}</span>
                            <span className="font-mono font-bold text-rose-600 text-xl">{currentScore} pts</span>
                            {!gameState.showAnswer && (
                                <div className="absolute bottom-0 left-0 h-1 bg-rose-500 timer-progress" style={{ width: `${(clientTimer / 15) * 100}%` }}></div>
                            )}
                        </div>

                        <div className="p-6 pb-2">
                            <h2 className="text-xl font-bold text-slate-800">{q.q}</h2>
                        </div>

                        <div className="flex-1 p-4 flex flex-col gap-3 pb-10">
                            {q.a.map((opt, i) => {
                                let statusClass = "bg-white text-slate-700 shadow-sm border-2 border-transparent";
                                if (gameState.showAnswer) {
                                    // Highlight ข้อที่ถูกเป็นสีเขียวเสมอ (Solid Green)
                                    if (i === q.c) statusClass = "correct-answer-highlight"; 
                                    else if (i === selected) statusClass = "bg-red-500 text-white border-red-600 opacity-60";
                                    else statusClass = "bg-slate-200 text-slate-400 opacity-40";
                                } else if (selected !== null) {
                                    if (i === selected) statusClass = "bg-rose-500 text-white border-rose-600";
                                    else statusClass = "bg-slate-100 text-slate-400 opacity-50 scale-95";
                                }
                                return (
                                    <button key={i} disabled={selected !== null || gameState.showAnswer} onClick={() => handleAnswer(i)} className={`p-5 rounded-xl text-left font-medium text-lg transition-all duration-200 ${statusClass}`}>
                                        {opt}
                                        {gameState.showAnswer && i === q.c && <i className="fa-solid fa-check float-right"></i>}
                                        {gameState.showAnswer && i === selected && i !== q.c && <i className="fa-solid fa-xmark float-right"></i>}
                                    </button>
                                );
                            })}
                        </div>
                        
                        {/* ANSWER POPUP (Big Reveal) */}
                        {gameState.showAnswer && (
                             <div className="fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center p-4 animate-fade-in">
                                <div className="text-white text-2xl mb-4 font-bold">เฉลย</div>
                                <div className="bg-white p-8 rounded-3xl w-full max-w-md text-center shadow-2xl">
                                     <div className="text-slate-500 mb-2 text-lg">คำตอบที่ถูกคือ</div>
                                     <div className="text-3xl font-black text-green-600 mb-6 leading-tight">
                                        {QUESTIONS[gameState.qIdx].a[QUESTIONS[gameState.qIdx].c]}
                                     </div>
                                     <div className="text-sm text-slate-400 animate-pulse">กำลังไปข้อต่อไปใน 5 วินาที...</div>
                                </div>
                             </div>
                        )}
                    </div>
                );
            }

            if (gameState.status === 'finished') {
                return (
                    <div className="min-h-screen bg-purple-600 p-6 flex flex-col items-center justify-center text-white text-center">
                        <i className="fa-solid fa-flag-checkered text-6xl mb-6 text-yellow-300"></i>
                        <h2 className="text-3xl font-bold mb-2">จบเกมแล้ว!</h2>
                        
                        <div className="bg-white/10 rounded-2xl p-6 mt-6 w-full max-w-xs backdrop-blur-sm border border-white/20 shadow-xl">
                            <div className="text-white text-xl mb-2">ผู้เล่น:</div>
                            <div className="text-3xl font-bold text-yellow-300 mb-4 bg-black/20 rounded-lg py-2 px-4">{name}</div>
                            <div className="w-full h-px bg-white/20 mb-4"></div>
                            <p className="text-sm opacity-70">คะแนนของคุณ</p>
                            <div className="text-6xl font-black my-2">{currentScore}</div>
                        </div>
                        
                        <p className="mt-8 opacity-80 animate-pulse">ดูรายชื่อผู้ชนะได้ที่หน้าจอครู</p>
                    </div>
                );
            }
            return <div className="p-10 text-center">Loading Game...</div>;
        };

        // ==========================================
        // 4. MAIN APP
        // ==========================================
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [authError, setAuthError] = React.useState(null);
            const [mode, setMode] = React.useState('menu'); 

            React.useEffect(() => {
                const init = async () => { 
                    try {
                        await auth.signInAnonymously(); 
                    } catch (err) {
                        console.error("Auth Init Error:", err);
                        // Check for referer blocked error
                        if (err.message.includes("requests-from-referer")) {
                            setAuthError("API Key ถูกจำกัดสิทธิ์ (Domain Restricted). โดเมนของหน้าเว็บนี้ไม่ได้รับอนุญาต");
                        } else if (err.message.includes("configuration-not-found") || err.code === "auth/configuration-not-found") {
                            setAuthError("ยังไม่ได้เปิดใช้งาน Anonymous Auth ใน Firebase Console (เมนู Authentication > Sign-in method > เปิด Anonymous)");
                        } else {
                            setAuthError(err.message);
                        }
                    }
                };
                init();
                
                const unsub = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        setAuthError(null);
                    }
                }, (err) => {
                    setAuthError(err.message);
                });
                
                return () => unsub();
            }, []);

            if (mode === 'menu') return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-20 h-20 bg-rose-500 rounded-full flex items-center justify-center text-4xl text-white mb-6 shadow-lg shadow-rose-500/50">
                        <i className="fa-solid fa-bolt"></i>
                    </div>
                    <h1 className="text-4xl font-bold text-white mb-2">OSCC Live Quiz</h1>
                    <p className="text-slate-400 mb-10">ระบบห้องเรียนตอบคำถาม Real-time (Auto)</p>
                    
                    {authError && (
                        <div className="mb-4 bg-red-500/20 border border-red-500 text-red-200 p-4 rounded-lg text-sm max-w-md mx-auto text-left">
                            <p className="font-bold mb-2">⚠️ เกิดข้อผิดพลาดการเชื่อมต่อ (Connection Error)</p>
                            <p className="mb-2">{authError}</p>
                            <p className="text-xs opacity-80">
                                <strong>คำแนะนำ:</strong> กรุณาตรวจสอบการตั้งค่า Firebase Console ตามข้อความแจ้งเตือนด้านบน
                            </p>
                        </div>
                    )}

                    <div className="flex flex-col gap-4 w-full max-w-sm">
                        <button onClick={() => setMode('teacher')} className="bg-white text-slate-900 p-4 rounded-xl font-bold text-lg hover:bg-slate-100 flex items-center justify-center gap-3"><i className="fa-solid fa-chalkboard-user"></i> โหมดควบคุม (ครู)</button>
                        <button onClick={() => setMode('student')} className="bg-rose-500 text-white p-4 rounded-xl font-bold text-lg hover:bg-rose-600 shadow-lg shadow-rose-900/50 flex items-center justify-center gap-3"><i className="fa-solid fa-gamepad"></i> เข้าเล่น (นักเรียน)</button>
                    </div>
                </div>
            );
            if (mode === 'teacher') return <TeacherMode user={user} authError={authError} />;
            if (mode === 'student') return <StudentMode user={user} goHome={() => setMode('menu')} authError={authError} />;
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
