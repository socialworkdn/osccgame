<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OSCC Live Game & Dashboard</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase SDKs (Compat Version for Standalone Usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ส่วนตั้งค่า Firebase (สำคัญมากสำหรับการนำไปใช้เอง)
        // ==========================================
        
        // 1. ไปที่ https://console.firebase.google.com/
        // 2. สร้างโปรเจกต์ > เพิ่มแอป Web (</>) > คัดลอก config มาใส่แทนที่ null ด้านล่างนี้
        const YOUR_FIREBASE_CONFIG = {
  apiKey: "AIzaSyAdXrEJVOU8zHtnCjd0tnCT0Gg9ZIioYeE",
  authDomain: "oscc-quiz.firebaseapp.com",
  projectId: "oscc-quiz",
  storageBucket: "oscc-quiz.firebasestorage.app",
  messagingSenderId: "246513256530",
  appId: "1:246513256530:web:ba60ab8ec6c8f2a1d4f78b",
  measurementId: "G-EV1HQLEGRE"
}; 
        
        // ------------------------------------------
        // Logic การเลือกใช้ Config (ไม่ต้องแก้ไขส่วนนี้)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config); // ใช้ค่าจากระบบ Preview
        } else if (YOUR_FIREBASE_CONFIG) {
            firebaseConfig = YOUR_FIREBASE_CONFIG; // ใช้ค่าที่คุณใส่เอง
        } else {
            alert("⚠️ ไม่พบการตั้งค่า Firebase!\nกรุณาเปิดไฟล์และแก้ไขตัวแปร 'YOUR_FIREBASE_CONFIG' ก่อนใช้งาน");
            throw new Error("Firebase Config missing");
        }
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        // ใช้ projectId เป็น appId ถ้าไม่มีการกำหนดค่า __app_id
        const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-oscc-app');

        // Helper to get collection reference easily
        const getScoresCollection = () => {
            // ใช้ Path มาตรฐานสำหรับเก็บข้อมูล
            return db.collection('oscc_quiz_scores');
        };
        // ==========================================

        // Questions Data
        const QUESTIONS = [
            { q: "OSCC ย่อมาจากอะไร?", a: ["One Stop Service Center", "One Stop Crisis Center", "Online Social Care", "One Safe Child Center"], c: 1 },
            { q: "แจ้งเหตุ OSCC รพ.ดำเนินสะดวก โทรเบอร์?", a: ["1669", "191", "622", "1112"], c: 2 },
            { q: "เกณฑ์ผู้ป่วย 'เด็ก' ต้องอายุไม่เกินกี่ปี?", a: ["12 ปี", "15 ปี", "18 ปี", "20 ปี"], c: 2 },
            { q: "ข้อใด 'ไม่นับ' เป็นเคส OSCC?", a: ["สามีทำร้ายภรรยา", "วัยรุ่นตีกันเอง (วิวาททั่วไป)", "แม่เลี้ยงตีลูกเลี้ยง", "ครูทำร้ายนักเรียน"], c: 1 },
            { q: "ความรุนแรงทางเพศ ต้องส่ง OSCC หรือไม่?", a: ["ส่งเฉพาะผู้หญิง", "ส่งเฉพาะเด็ก", "ส่งทุกกรณี", "ไม่ต้องส่ง"], c: 2 },
            { q: "ด่านแรกใน รพ. เมื่อผู้ป่วยมาถึงคือ?", a: ["ห้องฉุกเฉิน (ER)", "ทันตกรรม", "ห้องผ่าตัด", "กลับบ้าน"], c: 0 },
            { q: "นักสังคมสงเคราะห์ รพ.ดำเนินฯ ชื่อพี่อะไร?", a: ["พี่ป้อม", "พี่ปอม", "พี่ปลา", "พี่เปิ้ล"], c: 1 },
            { q: "ผู้ชายถูกทำร้าย เป็น OSCC เมื่อ?", a: ["ถูกแฟน/คนในบ้านทำร้าย", "ถูกเพื่อนต่อย", "โดนรุมหน้างานวัด", "เป็นทุกกรณี"], c: 0 },
            { q: "หัวใจสำคัญของการทำงาน OSCC คือ?", a: ["ออกข่าว", "จับโจร", "รักษาความลับ/ความปลอดภัย", "เรียกเงิน"], c: 2 },
            { q: "สโลแกนสำคัญคือ?", a: ["ไม่ยุ่งเรื่องชาวบ้าน", "ไม่ยอมรับ ไม่นิ่งเฉย ไม่กระทำ", "รักวัวให้ผูก รักลูกให้ตี", "ตาต่อตา ฟันต่อฟัน"], c: 1 }
        ];

        // --- 2. REACT COMPONENTS ---

        const MainMenu = ({ setMode }) => (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-400 to-rose-500 p-4">
                <div className="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl animate-pop">
                    <div className="w-24 h-24 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-500 text-4xl shadow-inner">
                        <i className="fa-solid fa-heart-pulse"></i>
                    </div>
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">OSCC Live Quiz</h1>
                    <p className="text-gray-500 mb-8">โรงพยาบาลดำเนินสะดวก</p>

                    <button onClick={() => setMode('student')} className="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-4 rounded-xl text-xl mb-4 shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                        <i className="fa-solid fa-user-graduate"></i> เข้าเล่นเกม (นักเรียน)
                    </button>
                    
                    <button onClick={() => setMode('teacher')} className="w-full bg-white border-2 border-rose-200 text-rose-500 hover:bg-rose-50 font-bold py-3 rounded-xl text-lg transition flex items-center justify-center gap-2">
                        <i className="fa-solid fa-tv"></i> จอภาพรวม (สำหรับครู)
                    </button>
                </div>
            </div>
        );

        const TeacherDashboard = ({ user }) => {
            const [scores, setScores] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!user) return;
                
                // Real-time listener using Compat syntax
                const scoresRef = getScoresCollection();
                
                const unsubscribe = scoresRef.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort locally
                    const sorted = data.sort((a, b) => b.score - a.score);
                    setScores(sorted);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching scores:", error);
                    setLoading(false);
                    if(error.code === 'permission-denied') {
                        alert("Permission Denied: กรุณาตรวจสอบ Firestore Rules ใน Firebase Console ให้อนุญาต read/write");
                    }
                });

                return () => unsubscribe();
            }, [user]);

            const handleReset = async () => {
                if(!confirm("คุณต้องการล้างคะแนนทั้งหมดหรือไม่?")) return;
                try {
                    const snapshot = await getScoresCollection().get();
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                } catch (error) {
                    console.error("Error clearing scores:", error);
                    alert("เกิดข้อผิดพลาดในการล้างคะแนน");
                }
            };

            return (
                <div className="min-h-screen bg-slate-800 text-white p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-8 bg-slate-700 p-4 rounded-xl">
                            <h1 className="text-2xl font-bold flex items-center gap-3">
                                <i className="fa-solid fa-trophy text-yellow-400"></i> Leaderboard (Real-time)
                            </h1>
                            <div className="text-right">
                                <p className="text-sm text-gray-400">ผู้เล่นทั้งหมด</p>
                                <p className="text-3xl font-bold text-emerald-400">{scores.length}</p>
                            </div>
                        </div>

                        {loading ? (
                            <div className="text-center py-20 text-gray-400">กำลังเชื่อมต่อ...</div>
                        ) : scores.length === 0 ? (
                            <div className="text-center py-20 bg-slate-700/50 rounded-2xl border border-dashed border-slate-600">
                                <i className="fa-solid fa-users text-4xl mb-4 text-slate-500"></i>
                                <p>ยังไม่มีผู้เล่นส่งคะแนนเข้ามา</p>
                                <p className="text-sm text-gray-500 mt-2">ให้นักเรียนเข้าลิงก์และเริ่มเล่นเกมได้เลย</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {scores.slice(0, 50).map((player, idx) => (
                                    <div key={player.id} className={`flex items-center p-4 rounded-xl transition-all duration-500 animate-pop ${idx < 3 ? 'bg-gradient-to-r from-slate-700 to-slate-600 border border-slate-500' : 'bg-slate-700/50'}`}>
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold mr-4 ${
                                            idx === 0 ? 'bg-yellow-400 text-yellow-900' :
                                            idx === 1 ? 'bg-gray-300 text-gray-800' :
                                            idx === 2 ? 'bg-amber-600 text-amber-100' :
                                            'bg-slate-800 text-slate-400'
                                        }`}>
                                            {idx + 1}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-lg">{player.name}</h3>
                                            <p className="text-xs text-slate-400"><i className="fa-regular fa-clock"></i> {player.timestamp ? new Date(player.timestamp.seconds * 1000).toLocaleTimeString('th-TH') : 'Just now'}</p>
                                        </div>
                                        <div className="text-2xl font-mono font-bold text-emerald-400">
                                            {player.score.toLocaleString()}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        <div className="mt-10 text-center">
                            <button onClick={handleReset} className="text-sm text-red-400 hover:text-red-300 underline">
                                ล้างคะแนนทั้งหมด (Reset)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StudentGame = ({ user, goHome }) => {
            const [gameState, setGameState] = React.useState('lobby'); // lobby, playing, finished
            const [name, setName] = React.useState('');
            const [qIdx, setQIdx] = React.useState(0);
            const [score, setScore] = React.useState(0);
            const [timeLeft, setTimeLeft] = React.useState(15);
            const [selected, setSelected] = React.useState(null);
            const [isCorrect, setIsCorrect] = React.useState(null); // null, true, false
            
            const timerRef = React.useRef(null);

            // Timer Logic
            React.useEffect(() => {
                if (gameState === 'playing' && selected === null) {
                    if (timeLeft > 0) {
                        timerRef.current = setTimeout(() => setTimeLeft(prev => prev - 1), 1000);
                    } else {
                        handleAnswer(-1); // Time out
                    }
                }
                return () => clearTimeout(timerRef.current);
            }, [timeLeft, gameState, selected]);

            const startGame = () => {
                if (!name.trim()) return alert("กรุณากรอกชื่อ");
                setGameState('playing');
                setScore(0);
                setQIdx(0);
                setTimeLeft(15);
            };

            const handleAnswer = (idx) => {
                setSelected(idx);
                const correctIdx = QUESTIONS[qIdx].c;
                
                let points = 0;
                let correct = false;

                if (idx === correctIdx) {
                    // Base 500 + Speed Bonus (max 500)
                    points = 500 + Math.round((timeLeft / 15) * 500);
                    correct = true;
                }

                setScore(prev => prev + points);
                setIsCorrect(correct);

                // Delay next question
                setTimeout(() => {
                    if (qIdx < QUESTIONS.length - 1) {
                        setQIdx(prev => prev + 1);
                        setTimeLeft(15);
                        setSelected(null);
                        setIsCorrect(null);
                    } else {
                        finishGame(score + points); // Pass final score
                    }
                }, 1500);
            };

            const finishGame = async (finalScore) => {
                setGameState('finished');
                // Upload to Firebase using Compat syntax
                if (user) {
                    try {
                        await getScoresCollection().add({
                            name: name,
                            score: finalScore,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Upload failed", e);
                        alert("เกิดข้อผิดพลาดในการส่งคะแนน (ตรวจสอบ Internet หรือ Firestore Rules)");
                    }
                }
            };

            if (gameState === 'lobby') {
                return (
                    <div className="min-h-screen bg-rose-50 p-6 flex flex-col items-center justify-center">
                        <button onClick={goHome} className="absolute top-4 left-4 text-gray-400"><i className="fa-solid fa-arrow-left"></i> กลับ</button>
                        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center">
                            <h2 className="text-2xl font-bold text-rose-600 mb-6">ลงทะเบียนผู้เล่น</h2>
                            <input 
                                type="text" 
                                value={name} 
                                onChange={e => setName(e.target.value)}
                                placeholder="กรอกชื่อของคุณ..." 
                                className="w-full bg-gray-100 p-4 rounded-xl mb-4 text-center text-lg focus:outline-none focus:ring-2 focus:ring-rose-400"
                            />
                            <button onClick={startGame} className="w-full bg-rose-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg">เริ่มเกมเลย!</button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'finished') {
                return (
                    <div className="min-h-screen bg-rose-500 p-6 flex flex-col items-center justify-center text-white text-center">
                        <i className="fa-solid fa-flag-checkered text-6xl mb-6 text-yellow-300 animate-bounce"></i>
                        <h2 className="text-3xl font-bold mb-2">จบเกมแล้ว!</h2>
                        <p className="opacity-80 mb-6">คุณทำได้ยอดเยี่ยมมาก</p>
                        
                        <div className="bg-white text-gray-800 p-6 rounded-3xl w-full max-w-sm mb-6 shadow-2xl">
                            <p className="text-sm text-gray-500">คะแนนของคุณ</p>
                            <div className="text-5xl font-black text-rose-500 my-2">{score.toLocaleString()}</div>
                            <p className="text-sm text-gray-400">ชื่อ: {name}</p>
                        </div>

                        <p className="text-sm animate-pulse">คะแนนถูกส่งไปที่หน้าจอครูแล้ว...</p>
                        <button onClick={() => window.location.reload()} className="mt-8 text-white/70 hover:text-white underline">กลับหน้าหลัก</button>
                    </div>
                );
            }

            // Playing State
            const q = QUESTIONS[qIdx];
            return (
                <div className="min-h-screen bg-slate-100 flex flex-col">
                    {/* Top Bar */}
                    <div className="bg-white p-4 shadow-sm flex justify-between items-center z-10 relative">
                        <div className="flex items-center gap-2">
                            <span className="bg-rose-100 text-rose-600 px-3 py-1 rounded-full font-bold text-sm">ข้อ {qIdx + 1}/10</span>
                        </div>
                        <div className="font-mono font-bold text-rose-600 text-xl">{score}</div>
                    </div>

                    {/* Timer Bar */}
                    <div className="h-2 bg-gray-200 w-full">
                        <div 
                            className="h-full bg-rose-500 transition-all duration-1000 ease-linear"
                            style={{ width: `${(timeLeft/15)*100}%` }}
                        ></div>
                    </div>

                    {/* Question */}
                    <div className="p-6 text-center bg-white rounded-b-3xl shadow-sm mb-4">
                        <h2 className="text-xl font-bold text-gray-800 leading-relaxed">{q.q}</h2>
                    </div>

                    {/* Options */}
                    <div className="flex-1 p-4 flex flex-col gap-3 max-w-md mx-auto w-full">
                        {q.a.map((opt, i) => {
                            let statusClass = "bg-white text-gray-700 hover:bg-gray-50 border-b-4 border-gray-200";
                            
                            if (selected !== null) {
                                if (i === q.c) statusClass = "bg-green-500 text-white border-green-700"; // Correct
                                else if (i === selected) statusClass = "bg-red-500 text-white border-red-700"; // Wrong selected
                                else statusClass = "bg-gray-200 text-gray-400 border-transparent opacity-50"; // Others
                            }

                            return (
                                <button 
                                    key={i}
                                    disabled={selected !== null}
                                    onClick={() => handleAnswer(i)}
                                    className={`p-4 rounded-xl text-left font-medium text-lg transition-all duration-200 shadow-sm ${statusClass}`}
                                >
                                    {opt}
                                    {selected !== null && i === q.c && <i className="fa-solid fa-check float-right mt-1"></i>}
                                    {selected !== null && i === selected && i !== q.c && <i className="fa-solid fa-xmark float-right mt-1"></i>}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- 3. MAIN APP ---

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [mode, setMode] = React.useState('menu'); // menu, student, teacher

            React.useEffect(() => {
                const initAuth = async () => {
                    // Check for custom token provided by environment
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } catch (err) {
                            console.error("Custom token sign-in failed, falling back to anonymous", err);
                            await auth.signInAnonymously();
                        }
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
                return () => unsubscribe();
            }, []);

            if (mode === 'menu') return <MainMenu setMode={setMode} />;
            if (mode === 'student') return <StudentGame user={user} goHome={() => setMode('menu')} />;
            if (mode === 'teacher') return <TeacherDashboard user={user} />;
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
